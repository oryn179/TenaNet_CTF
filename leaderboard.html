<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TenaNet CTF Live Leaderboard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* --- Font Setup --- */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Space+Mono:ital,wght@0,400;0,700;1,400;1,700&display=swap');
        
        :root {
            --fuchsia-main: #db2777; /* fuchsia-600 */
            --violet-main: #8b5cf6; /* violet-500 */
        }

        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.5s, color 0.5s;
        }

        /* --- PARTICLE BACKGROUND CSS --- */
        .particle-bg {
            position: relative;
            overflow: hidden;
            z-index: 1;
        }
        .particle-bg::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.05) 1px, transparent 1.5px);
            background-size: 50px 50px;
            opacity: 0.2;
            animation: moveParticles 20s linear infinite;
            pointer-events: none;
            z-index: -1;
        }
        @keyframes moveParticles {
            0% { transform: translate(0, 0); }
            100% { transform: translate(-100px, -100px); }
        }

        /* --- NEON GLOW THEME (Pro Mode) --- */
        @keyframes neonGlow {
            0%, 100% { box-shadow: 0 0 5px var(--violet-main), 0 0 10px var(--violet-main), 0 0 20px var(--violet-main); }
            50% { box-shadow: 0 0 7px #7c3aed, 0 0 14px #7c3aed, 0 0 28px #7c3aed; }
        }
        .shadow-neon {
            box-shadow: 0 0 15px rgba(139, 92, 246, 0.7); /* violet-500 */
        }
        .pro-active .shadow-neon {
            animation: neonGlow 3s ease-in-out infinite;
        }
        .pro-text-gradient {
            background-image: linear-gradient(45deg, #a78bfa, #c4b5fd, #ddd6fe);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        /* Utility icons (using SVG for simplicity) */
        .icon {
            display: inline-block;
            width: 1.25rem;
            height: 1.25rem;
            stroke-width: 2;
            stroke: currentColor;
            fill: none;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
    </style>
</head>
<body class="min-h-screen">
    
    <div id="app" class="min-h-screen p-4 sm:p-8 transition-all duration-500 bg-white text-gray-800 font-sans particle-bg">
        <!-- Content will be rendered here -->
        <div id="loading-screen" class="flex items-center justify-center min-h-screen">
            <div class="text-xl font-semibold text-fuchsia-600 animate-pulse">Loading Leaderboard...</div>
        </div>
    </div>

    <!-- Firebase Imports and Main JavaScript Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            query, 
            onSnapshot, 
            addDoc,
            serverTimestamp,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // =====================================================================
        // === GLOBAL CONFIG & STATE ===
        // =====================================================================

        // Global variables provided by the canvas environment
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' 
            ? __initial_auth_token 
            : null;

        // The special "Pro Code"
        const PRO_CODE = "TENA_NET_THE_BEST";

        // CTF Closing Date: NOV 1 AT 12:00AM (Midnight 2025-11-01)
        const CLOSING_DATE = new Date('2025-11-01T00:00:00').getTime(); 

        let db = null;
        let auth = null;
        let userId = '';
        let userEmail = '';
        let scores = [];
        let isLoading = true;
        let isPro = false;
        let timeRemaining = CLOSING_DATE - Date.now();
        let error = '';

        // =====================================================================
        // === UTILITY FUNCTIONS (Icons, Formatting) ===
        // =====================================================================

        // Utility function to generate Lucide-like SVG icons
        const getIconSVG = (name, className = 'w-5 h-5') => {
            const icons = {
                'Trophy': '<path d="M18 10a6 6 0 0 0-12 0v5l4 4 4-4v-5l-4-4 4 4Z"/><path d="M12 21.5l-4-4V10a6 6 0 0 1 12 0v7.5l-4 4Z"/>',
                'Zap': '<path d="M13 2L3 14h8l-1 8 10-12h-8l1-8z"/>',
                'Clock': '<circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>',
                'User': '<path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>',
                'CheckCircle': '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>',
                'XCircle': '<circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/>',
                'ShieldOff': '<path d="M19.5 7.5A.5.5 0 0 1 20 8l-8 13-8-13a2 2 0 0 1 1.77-3L12 2l2.25 4.5"/><line x1="2" x2="22" y1="2" y2="22"/>'
            };
            const path = icons[name] || '';
            return `<svg class="icon ${className}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">${path}</svg>`;
        };

        const formatScore = (score) => score.toLocaleString();

        const formatTime = (ms) => {
            if (ms < 0) return "CLOSED";
            const totalSeconds = Math.floor(ms / 1000);
            const days = Math.floor(totalSeconds / (3600 * 24));
            const hours = Math.floor((totalSeconds % (3600 * 24)) / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;

            const parts = [];
            if (days > 0) parts.push(`${days}d`);
            if (hours > 0) parts.push(`${hours}h`);
            if (minutes > 0) parts.push(`${minutes}m`);
            parts.push(`${seconds}s`);

            return parts.join(' ');
        };

        // =====================================================================
        // === RENDER & UI UPDATE FUNCTIONS ===
        // =====================================================================

        const getBaseClasses = () => ({
            baseBg: isPro ? 'bg-gray-900' : 'bg-white',
            baseText: isPro ? 'text-white' : 'text-gray-800',
            accent: isPro ? 'text-violet-400' : 'text-fuchsia-600',
            cardBg: isPro 
                ? 'bg-gray-800 border-violet-500/50 shadow-neon' 
                : 'bg-fuchsia-50 border-gray-200 shadow-lg',
            inputStyle: isPro 
                ? 'bg-gray-700 text-violet-300 border-violet-700 placeholder:text-violet-500 focus:ring-violet-400' 
                : 'bg-white text-gray-800 border-gray-300 focus:ring-fuchsia-500',
        });

        const updateAppClasses = (classes) => {
            const appDiv = document.getElementById('app');
            appDiv.className = `min-h-screen p-4 sm:p-8 transition-all duration-500 ${classes.baseBg} ${classes.baseText} font-sans particle-bg ${isPro ? 'pro-active' : ''}`;
        };

        const updateCountdown = () => {
            const timeElement = document.getElementById('time-remaining');
            const countdownContainer = document.getElementById('countdown-container');
            if (timeElement && countdownContainer) {
                const isClosed = timeRemaining < 0;
                timeElement.textContent = isClosed ? 'CLOSED' : formatTime(timeRemaining);

                const baseClasses = getBaseClasses();
                
                let containerClasses = `p-4 mb-8 text-center rounded-xl shadow-lg transition-colors duration-500`;
                if (isClosed) {
                    containerClasses += ' bg-red-800 text-white border-2 border-red-500';
                    timeElement.className = 'text-4xl font-extrabold font-mono text-white';
                } else {
                    containerClasses += isPro 
                        ? ' bg-violet-900/50 text-violet-300 shadow-xl shadow-fuchsia-900/30' 
                        : ' bg-fuchsia-700 text-white';
                    timeElement.className = 'text-4xl font-extrabold font-mono text-yellow-300';
                }
                countdownContainer.className = containerClasses;

                // Disable submission if closed
                const submitButton = document.getElementById('submit-score-btn');
                const scoreInput = document.getElementById('new-score-input');
                const usernameInput = document.getElementById('username-input');
                if (submitButton) {
                    const submissionSection = document.getElementById('submission-section');
                    submitButton.disabled = isClosed;
                    submitButton.textContent = isClosed ? 'CTF CLOSED' : 'POST SCORE';
                    if (isClosed) {
                        submissionSection.classList.add('opacity-50', 'pointer-events-none');
                    } else {
                        submissionSection.classList.remove('opacity-50', 'pointer-events-none');
                    }
                    if (scoreInput) scoreInput.disabled = isClosed;
                    if (usernameInput) usernameInput.disabled = isClosed;
                }
            }
        };

        const renderLeaderboard = () => {
            const tbody = document.getElementById('leaderboard-tbody');
            if (!tbody) return;

            const classes = getBaseClasses();
            tbody.innerHTML = ''; // Clear previous content

            if (scores.length === 0) {
                tbody.innerHTML = `<tr><td colSpan="4" class="px-6 py-4 text-center text-gray-500">
                    No scores yet! Be the first to post a score.
                </td></tr>`;
                return;
            }

            scores.slice(0, 10).forEach((entry, index) => {
                const isCurrentUser = entry.userId === userId;
                const rowClasses = isCurrentUser 
                    ? `font-extrabold ${isPro ? 'bg-violet-800/30' : 'bg-fuchsia-100'} hover:opacity-90`
                    : `hover:opacity-80 ${isPro ? '' : 'text-gray-700'}`;
                
                let rankStyle = '';
                if (index === 0) rankStyle = `${isPro ? 'text-yellow-400' : 'text-yellow-500'} text-xl`;
                else if (index === 1) rankStyle = `${isPro ? 'text-slate-400' : 'text-slate-400'} text-lg`;
                else if (index === 2) rankStyle = `${isPro ? 'text-amber-700' : 'text-amber-600'} text-md`;
                else rankStyle = 'text-gray-500';

                const row = document.createElement('tr');
                row.className = rowClasses;
                row.innerHTML = `
                    <td class="px-6 py-3 whitespace-nowrap ${rankStyle}">${index + 1}</td>
                    <td class="px-6 py-3 whitespace-nowrap font-semibold flex items-center">
                        ${getIconSVG('User', 'w-4 h-4 mr-2 text-gray-400 hidden sm:inline')}
                        ${entry.username}
                        ${isCurrentUser ? `<span class="ml-2 text-xs font-bold px-2 py-0.5 rounded-full ${isPro ? 'bg-violet-500 text-black' : 'bg-fuchsia-600 text-white'}">YOU</span>` : ''}
                    </td>
                    <td class="px-6 py-3 whitespace-nowrap text-xs font-mono hidden sm:table-cell ${isPro ? 'text-gray-500' : 'text-gray-400'}">
                        ${entry.userId}
                    </td>
                    <td class="px-6 py-3 whitespace-nowrap text-right font-extrabold ${isCurrentUser ? 'text-3xl' : 'text-2xl'} ${isPro ? 'text-white' : classes.accent}">
                        ${formatScore(entry.score)}
                    </td>
                `;
                tbody.appendChild(row);
            });
        };

        const renderError = (msg) => {
            const errorElement = document.getElementById('error-message');
            if (errorElement) {
                errorElement.textContent = msg;
            }
            error = msg;
        };
        
        const renderMainApp = () => {
            const classes = getBaseClasses();
            updateAppClasses(classes);

            const appDiv = document.getElementById('app');
            appDiv.innerHTML = `
                <main class="max-w-4xl mx-auto z-10 relative">
                    <h1 class="text-4xl sm:text-5xl font-extrabold text-center mb-4 transition-colors duration-500 ${isPro ? 'pro-text-gradient' : classes.accent}" id="main-title">
                        ${isPro ? '/// PRO-LEVEL CTF LEADERBOARD ONLINE ///' : 'Standard Scoreboard'}
                    </h1>
                    
                    <!-- Countdown Timer -->
                    <div id="countdown-container">
                        <p class="text-xs font-semibold uppercase mb-1 flex items-center justify-center">
                            ${getIconSVG('Clock', 'w-4 h-4 mr-2')}
                            CTF Challenge Closes: NOV 1, 12:00 AM
                        </p>
                        <p class="text-4xl font-extrabold font-mono" id="time-remaining"></p>
                    </div>

                    <p class="text-center mb-10 text-sm ${isPro ? 'text-gray-400' : 'text-gray-500'}" id="auth-info">
                      Auth Email: <code class="font-mono font-bold text-sm">${userEmail || 'N/A (Anonymous)'}</code> | 
                      User ID: <code class="font-mono font-bold text-sm">${userId}</code>
                    </p>

                    <!-- PRO CODE Section -->
                    <section class="p-4 mb-8 rounded-xl transition-all duration-500 ${classes.cardBg} border-2">
                        <div class="flex items-center justify-between">
                            <h2 class="text-2xl font-bold flex items-center ${isPro ? 'text-violet-400' : 'text-gray-400'}">
                                ${getIconSVG('Zap', 'w-6 h-6 mr-2')}
                                Pro Access
                            </h2>
                            <span class="flex items-center text-lg font-semibold ${isPro ? 'text-violet-400' : 'text-red-400'}">
                                ${isPro ? getIconSVG('CheckCircle', 'w-5 h-5 mr-1') : getIconSVG('XCircle', 'w-5 h-5 mr-1')}
                                ${isPro ? 'UNLOCKED' : 'LOCKED'}
                            </span>
                        </div>
                        ${!isPro ? `
                            <form id="pro-code-form" class="mt-4 flex flex-col sm:flex-row gap-2">
                                <input
                                    type="text"
                                    id="pro-code-input"
                                    placeholder="Enter Pro Code (TENA_NET_THE_BEST)"
                                    class="flex-grow p-3 rounded-lg border-2 focus:outline-none focus:ring-4 transition-colors duration-300 ${classes.inputStyle}"
                                />
                                <button
                                    type="submit"
                                    class="w-full sm:w-auto px-6 py-3 font-bold rounded-lg text-white bg-fuchsia-600 hover:bg-fuchsia-700 transition-colors duration-300 shadow-md hover:shadow-lg interactive-element"
                                >
                                    Activate Pro View
                                </button>
                            </form>
                        ` : ''}
                    </section>


                    <!-- SCORE SUBMISSION Section -->
                    <section class="p-4 mb-8 rounded-xl transition-all duration-500 ${classes.cardBg} border-2" id="submission-section">
                        <h2 class="text-xl font-bold mb-4 ${classes.accent}">Submit Your Score</h2>
                        <form id="score-submission-form" class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                            <input
                                type="text"
                                id="username-input"
                                placeholder="Your Username"
                                value="Player_${Math.floor(Math.random() * 1000)}"
                                class="col-span-1 p-3 rounded-lg border-2 focus:outline-none focus:ring-2 ${classes.inputStyle}"
                                maxLength="20"
                                required
                            />
                            <input
                                type="number"
                                id="new-score-input"
                                placeholder="Enter Score (e.g., 5000)"
                                class="col-span-1 p-3 rounded-lg border-2 focus:outline-none focus:ring-2 ${classes.inputStyle}"
                                min="1"
                                required
                            />
                            <button
                                type="submit"
                                id="submit-score-btn"
                                class="col-span-1 px-6 py-3 font-bold rounded-lg text-white bg-fuchsia-600 hover:bg-fuchsia-700 transition-colors duration-300 shadow-md hover:shadow-lg interactive-element"
                            >
                                POST SCORE
                            </button>
                        </form>
                        <p id="error-message" class="mt-4 text-red-500 text-sm font-semibold"></p>
                    </section>


                    <!-- LEADERBOARD TABLE Section -->
                    <section class="p-4 rounded-xl transition-all duration-500 ${classes.cardBg} border-2">
                        <h2 class="text-3xl font-bold mb-6 flex items-center ${classes.accent}">
                            ${getIconSVG('Trophy', 'w-7 h-7 mr-2')}
                            Top 10 Global Scores
                        </h2>
                        
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y ${isPro ? 'divide-gray-700' : 'divide-gray-200'}">
                                <thead class="${isPro ? 'bg-gray-700/80' : 'bg-fuchsia-100'}">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider w-16">Rank</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Username</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider hidden sm:table-cell">User ID</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium uppercase tracking-wider">Score</th>
                                    </tr>
                                </thead>
                                <tbody id="leaderboard-tbody" class="divide-y ${isPro ? 'divide-gray-700' : 'divide-gray-200'}">
                                    <!-- Scores will be rendered here -->
                                </tbody>
                            </table>
                        </div>
                    </section>
                </main>
            `;
            
            // Re-attach event listeners after DOM update
            setupEventListeners();
            // Initial render of dynamic data
            updateCountdown();
            renderLeaderboard();
        };

        
        // =====================================================================
        // === CORE LOGIC (Firebase & Data) ===
        // =====================================================================

        const initFirebaseAndAuth = async () => {
            if (!firebaseConfig) {
                console.error("Firebase config is missing.");
                isLoading = false;
                renderError("Configuration Error: Firebase settings are missing.");
                return;
            }

            try {
                // setLogLevel('debug'); // Uncomment for debugging
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                const authenticate = async () => {
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            // If no token, sign in anonymously (default behavior)
                            await signInAnonymously(auth);
                        }
                    } catch (e) {
                        console.error("Authentication failed:", e);
                        renderError("Authentication Failed: Could not sign in.");
                    }
                };

                // Listen for auth state changes
                onAuthStateChanged(auth, (user) => {
                    isLoading = false;
                    if (user) {
                        // All authenticated users (token or anonymous) are considered valid
                        userId = user.uid;
                        userEmail = user.email || 'Anonymous';
                    } else {
                        // Fallback in case of auth failure, though sign-in should prevent this
                        userId = crypto.randomUUID(); 
                        userEmail = 'Unauthenticated';
                    }

                    // Always render the main app now that authorization is removed
                    renderMainApp();
                    setupLeaderboardListener();
                });

                authenticate();

            } catch (e) {
                console.error("Failed to initialize Firebase:", e);
                isLoading = false;
                renderError("Initialization Error: Check Firebase configuration.");
            }
        };

        const setupLeaderboardListener = () => {
            if (!db) {
                scores = [];
                renderLeaderboard();
                return;
            }

            // Public collection path: /artifacts/{appId}/public/data/leaderboard
            const leaderboardCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard');
            const q = query(leaderboardCollectionRef);

            console.log("Setting up live listener for leaderboard...");

            // Set up the real-time listener
            onSnapshot(q, (snapshot) => {
                const liveScores = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                // Client-side sort: Highest score first, then by earliest submission time (timestamp)
                liveScores.sort((a, b) => {
                    if (b.score !== a.score) {
                        return b.score - a.score; // Descending score
                    }
                    // Fallback for timestamp: use toMillis() if available, otherwise 0
                    const timeA = a.timestamp?.toMillis ? a.timestamp.toMillis() : 0;
                    const timeB = b.timestamp?.toMillis ? b.timestamp.toMillis() : 0;
                    return timeA - timeB; 
                });

                scores = liveScores;
                renderLeaderboard();
            }, (err) => {
                console.error("Firestore snapshot error:", err);
                renderError("Could not load leaderboard data.");
            });
        };

        const addScore = async (e) => {
            e.preventDefault();
            
            const usernameInput = document.getElementById('username-input');
            const newScoreInput = document.getElementById('new-score-input');
            
            if (timeRemaining < 0) {
                renderError("The CTF challenge is closed. Cannot submit new scores.");
                return;
            }

            if (!db || !userId) {
                renderError("Database connection not ready. Try refreshing.");
                return;
            }

            const scoreValue = parseInt(newScoreInput.value, 10);
            const username = usernameInput.value.trim();

            if (isNaN(scoreValue) || scoreValue <= 0) {
                renderError("Please enter a valid positive score.");
                return;
            }
            if (username.length < 3) {
                renderError("Username must be at least 3 characters.");
                return;
            }

            renderError(''); // Clear previous error
            
            try {
                // Exponential backoff mechanism for API calls
                for (let i = 0; i < 3; i++) {
                    try {
                        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard'), {
                            userId: userId,
                            username: username,
                            score: scoreValue,
                            timestamp: serverTimestamp(),
                        });
                        newScoreInput.value = '';
                        console.log("Score added successfully.");
                        return; // Success, break out of loop
                    } catch (e) {
                        if (i < 2) { // If not the last retry
                            const delay = Math.pow(2, i) * 1000;
                            console.warn(`Attempt ${i + 1} failed. Retrying in ${delay / 1000}s...`);
                            await new Promise(resolve => setTimeout(resolve, delay));
                        } else {
                            throw e; // Re-throw error on final failure
                        }
                    }
                }
            } catch (e) {
                console.error("Error adding document after retries: ", e);
                renderError("Failed to submit score. Check console for details.");
            }
        };

        const handleProCodeCheck = (e) => {
            e.preventDefault();
            const proCodeInput = document.getElementById('pro-code-input');
            if (proCodeInput && proCodeInput.value === PRO_CODE) {
                isPro = true;
                renderError('');
            } else {
                isPro = false;
                renderError('Invalid Pro Code. Try again!');
            }
            renderMainApp();
        };

        const setupEventListeners = () => {
            const submissionForm = document.getElementById('score-submission-form');
            if (submissionForm) {
                submissionForm.onsubmit = addScore;
            }
            const proCodeForm = document.getElementById('pro-code-form');
            if (proCodeForm) {
                proCodeForm.onsubmit = handleProCodeCheck;
            }
        };
        
        // =====================================================================
        // === INITIALIZATION ===
        // =====================================================================

        window.onload = () => {
            // Start the countdown timer immediately
            setInterval(() => {
                timeRemaining = CLOSING_DATE - Date.now();
                updateCountdown();
            }, 1000);

            // Initialize Firebase and start the application flow
            initFirebaseAndAuth();
        };

    </script>
</body>
</html>

